---
title: "RSA暗号 -実際の計算とRSAがもたらす誤解"
tags: [algorithm, encryption]
category: 暗号
date: 2020-08-18
excerpt: RSA暗号の実際の計算。実装に関してはまた後ほど。。。
---

鍵交換アルゴリズムとしてはすでに[脆弱性](https://wired.jp/2019/09/05/rsa-encryption-signature-validation-flaws/)が見つかっており、めっちゃ使われているという実績のみでCRYPTRECの運用監視暗号リストにへばりついているRSA暗号なわけですが、電子署名の、特に[署名検証においてはまだまだ現役](http://blog.livedoor.jp/k_urushima/archives/1721840.html)です。多分。

というわけで、手軽に感動できるRSA暗号の実際の計算をやってみるとともに、最後におまけでRSAがもたらす誤解を紹介したいと思います。

## データ受信者が秘密鍵を用意する
まずデータ受信者は2つの**互いに素**な**素数**p,qを秘密鍵として用意します。実際の実装では1000桁ほどの大きな素数を扱うのですが、この場合は単純化して```p = 5, q = 11```とします。

当然秘密鍵なのでこの二つの素数は秘密にしておかなければなりません。ブラウザのJavaScriptに書くとかダメ。絶対。

## データ受信者が公開鍵を用意する
再びデータ受信者が2つの公開鍵を用意します。1つ目は先ほど用意した2つの秘密鍵を掛けた数値n。つまり
```
n = p * q = 5 * 11 = 55
```
もう1つは任意の正の整数eです。実際の通信では```2^16 + 1 = 65537```が使われることが多いですが、今回は単純化して```e = 3```とします。

## データ受信者が復号のための鍵を用意する
まだ終わりではありません。データ受信者は今度は自分に送られてきた暗号文を復号するための鍵dを用意します。
具体的な算出方法は以下の通り。
### 復号鍵dの求め方
まず(p-1)と(q-1)の最小公倍数Lを求めます。

[ユークリッドの互除法](https://mathtrain.jp/euclid#:~:text=%E3%83%A6%E3%83%BC%E3%82%AF%E3%83%AA%E3%83%83%E3%83%89%E3%81%AE%E4%BA%92%E9%99%A4%E6%B3%95%EF%BC%88%E3%81%94,%E7%B4%A0%E6%97%A9%E3%81%8F%E8%A8%88%E7%AE%97%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95%E3%81%A7%E3%81%99%E3%80%82)を使ってp-1, q-1の最大公約数gを求めます。今回は4と10の最大公約数なので```g = 2```となります。Lは**p-1とq-1の最小公倍数**なので、
```
L = (p - 1) * (q - 1) / g = 4 * 10 / 2 = 20
```
になります。

＊今回の場合は簡単な整数なので暗算で最小公倍数を求めることができたかもしれませんが、実際の数値はもっと大きく、ユークリッドの互除法を用いて最大公約数を求めた後にそれを使って最小公倍数を求めることになります。


Lが求まったら、復号鍵dが求まります。復号鍵dの算出方法は
```
d = d * e - y * L = 1 の自然解
```
今回の場合```e = 3, L = 20```なので
```
d = 3d - 20y = 1 の自然解 ∴ d = 7, y = 1
```
となり、dが7になります。

これで鍵の用意は完了なので、いよいよ暗号と復号に入ります。

## 平文の暗号化
今回は文字列 "RSA" を暗号化したいと思います。まずは"R"を平文mとして暗号化します。暗号化の数式は以下の通りです。
```
暗号文c = m^e mod n
```
RをUS-ASCII変換すると52なので
```
c = 52^3 mod 55 = 28
```
この要領で"S","A"も暗号化すると、Sは47、Aは6になります。この時点で各バイト数を文字列に変換すると"(G	ACK"になり、これが暗号文になります。いい感じに暗号っぽくなってますね。

## 暗号文の復号
上記の方法で送信者が暗号化した文を今度は受信者が復号します。復号の数式は以下の通りです。
```
平文m = C^d mod n
```
一文字ずつ復号してくと、
```python
# "("の28を復号
28^7 mod 55 = 52
# "G"の47を復号
47^7 mod 55 = 53
# "ACK"の6を復号
6^7 mod 55 = 41
```
それぞれ文字列に変換すると"RSA"に戻ってますね。ここで確認しておきたいのが、送信者は公開鍵しか使っていないという点です。eもnも一般に公開される公開鍵ですので、送信者も使用できます。一方受信者は秘密鍵であるp,qから作成したLから作成した、実質的に秘密鍵であるdを使って復号をしています。これにより、受信者のみが復号できる暗号通信が完成します。

## RSAがもたらす誤解
RSAは、一つの公開鍵について秘密鍵が一つに定まる[**確定的暗号**](https://en.wikipedia.org/wiki/Deterministic_encryption)です(文献英語しかなかった...)。固定長のデータを一単位として暗号化する[ブロック暗号](https://qiita.com/shoichi0599/items/6082b765c1257b71985b)も確定的暗号だったりするのですが、一つの公開鍵についても動的に秘密鍵が変化する**確率的暗号**も存在します。しかし上述の通りRSA暗号の暗号化と復号の数式が
```
c = m^e mod n
m = c^d mod n
```
と対になっているがために「暗号アルゴリズムの指数のeとdを逆にすれば署名にも使えるんじゃね？」と一般化した誤解が生まれてしまったのです。しかし、このような暗号化と復号のアルゴリズムにおける対称性があるのはRSA暗号だけであり、なおかつ近年主流になっている[ECDSA](https://zoom-blc.com/what-is-ecdsa)や、主流ですらないDSAやGOSTなど、RSA以外の電子署名暗号方式は公開鍵暗号方式をベースにしたものではありません。よって、「電子署名とは、公開鍵暗号方式の秘密鍵で暗号化することである」というのは**紛れもない間違い**であることは頭の片隅に置いておいてください。

---

こんだけイキって書いておいて頓珍漢なこと言っていたらマジで恥ずかしいですが、もし全然違う事言っていたらコメントで教えていただけるとありがたいです。

参考になれば幸いです。

## 参考
http://blog.livedoor.jp/k_urushima/archives/1721840.html
https://qiita.com/angel_p_57/items/d7ffb9ec13b4dde3357d
https://qiita.com/shoichi0599/items/6082b765c1257b71985b
https://medium.com/blockchain-engineer-blog/%E7%A7%81%E3%81%AF%E5%85%AC%E9%96%8B%E9%8D%B5%E6%9A%97%E5%8F%B7%E6%96%B9%E5%BC%8F%E3%81%A8%E9%9B%BB%E5%AD%90%E7%BD%B2%E5%90%8D%E3%82%92%E7%90%86%E8%A7%A3%E3%81%A7%E3%81%8D%E3%81%A6%E3%81%84%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F%E3%82%88%E3%81%86%E3%81%A7%E3%81%99-af0894c3df0b
